{% extends 'mcs/goat-farm/base.html' %}

{% block title %}Notifications - Goat Farm{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Notifications</h1>
        <div>
            <a href="{% url 'goat_farm_dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Notification Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select class="form-select" name="type">
                        <option value="">All Types</option>
                        <option value="health" {% if request.GET.type == 'health' %}selected{% endif %}>Health</option>
                        <option value="financial" {% if request.GET.type == 'financial' %}selected{% endif %}>Financial</option>
                        <option value="maintenance" {% if request.GET.type == 'maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="birth" {% if request.GET.type == 'birth' %}selected{% endif %}>Birth</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">All Status</option>
                        <option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>Unread</option>
                        <option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>Read</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date Range</label>
                    <div class="input-group">
                        <input type="date" class="form-control" name="start_date" value="{{ request.GET.start_date }}">
                        <span class="input-group-text">to</span>
                        <input type="date" class="form-control" name="end_date" value="{{ request.GET.end_date }}">
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Summary -->
    <div class="row g-4 mb-4">
        <!-- Unread Notifications -->
        <div class="col-md-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Unread</h6>
                            <h2 class="card-title mb-0">{{ unread_count }}</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-bell"></i>
                        </div>
                    </div>
                    <p class="card-text mt-3 mb-0">
                        <small>New notifications</small>
                    </p>
                </div>
            </div>
        </div>

        <!-- Health Alerts -->
        <div class="col-md-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Health Alerts</h6>
                            <h2 class="card-title mb-0">{{ health_alerts_count }}</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                    </div>
                    <p class="card-text mt-3 mb-0">
                        <small>Require attention</small>
                    </p>
                </div>
            </div>
        </div>

        <!-- Financial Notifications -->
        <div class="col-md-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Financial</h6>
                            <h2 class="card-title mb-0">{{ financial_notifications_count }}</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <p class="card-text mt-3 mb-0">
                        <small>Payment updates</small>
                    </p>
                </div>
            </div>
        </div>

        <!-- Upcoming Events -->
        <div class="col-md-6 col-lg-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Upcoming Events</h6>
                            <h2 class="card-title mb-0">{{ upcoming_events_count }}</h2>
                        </div>
                        <div class="icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <p class="card-text mt-3 mb-0">
                        <small>Next 7 days</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="card">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">All Notifications</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" id="markAllRead">
                    <i class="fas fa-check-double me-2"></i>Mark All as Read
                </button>
                <button class="btn btn-sm btn-outline-danger" id="clearAll">
                    <i class="fas fa-trash-alt me-2"></i>Clear All
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            {% if notifications %}
            <div class="list-group list-group-flush">
                {% for notification in notifications %}
                <div class="list-group-item notification-item {% if not notification.is_read %}unread{% endif %}"
                     data-notification-id="{{ notification.id }}">
                    <div class="d-flex align-items-center">
                        <div class="notification-icon me-3">
                            {% if notification.type == 'health' %}
                            <i class="fas fa-heartbeat text-danger"></i>
                            {% elif notification.type == 'financial' %}
                            <i class="fas fa-money-bill-wave text-success"></i>
                            {% elif notification.type == 'maintenance' %}
                            <i class="fas fa-tools text-warning"></i>
                            {% elif notification.type == 'birth' %}
                            <i class="fas fa-baby text-info"></i>
                            {% else %}
                            <i class="fas fa-bell text-primary"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0">{{ notification.title }}</h6>
                                <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ notification.message }}</p>
                            {% if notification.action_url %}
                            <a href="{{ notification.action_url }}" class="btn btn-sm btn-outline-primary">
                                {{ notification.action_text|default:"View Details" }}
                            </a>
                            {% endif %}
                        </div>
                        <div class="ms-3">
                            {% if not notification.is_read %}
                            <button class="btn btn-sm btn-outline-primary mark-read" 
                                    data-notification-id="{{ notification.id }}">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-danger delete-notification"
                                    data-notification-id="{{ notification.id }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if notifications.has_other_pages %}
            <nav class="p-3">
                <ul class="pagination justify-content-center mb-0">
                    {% if notifications.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ notifications.previous_page_number }}">
                            Previous
                        </a>
                    </li>
                    {% endif %}

                    {% for num in notifications.paginator.page_range %}
                    {% if notifications.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if notifications.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ notifications.next_page_number }}">
                            Next
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">No notifications available</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    let currentAction = null;
    let currentNotificationId = null;

    // Mark single notification as read
    document.querySelectorAll('.mark-read').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.dataset.notificationId;
            markAsRead(notificationId);
        });
    });

    // Delete single notification
    document.querySelectorAll('.delete-notification').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.dataset.notificationId;
            showConfirmation('Are you sure you want to delete this notification?', () => {
                deleteNotification(notificationId);
            });
        });
    });

    // Mark all as read
    document.getElementById('markAllRead').addEventListener('click', function() {
        showConfirmation('Are you sure you want to mark all notifications as read?', () => {
            markAllAsRead();
        });
    });

    // Clear all notifications
    document.getElementById('clearAll').addEventListener('click', function() {
        showConfirmation('Are you sure you want to delete all notifications? This action cannot be undone.', () => {
            clearAllNotifications();
        });
    });

    function showConfirmation(message, callback) {
        document.getElementById('confirmationMessage').textContent = message;
        currentAction = callback;
        confirmationModal.show();
    }

    document.getElementById('confirmAction').addEventListener('click', function() {
        if (currentAction) {
            currentAction();
            confirmationModal.hide();
        }
    });

    function markAsRead(notificationId) {
        fetch(`/goat-farm/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
                notification.classList.remove('unread');
                const markReadButton = notification.querySelector('.mark-read');
                if (markReadButton) {
                    markReadButton.remove();
                }
                updateNotificationCounts();
            }
        })
        .catch(error => console.error('Error marking notification as read:', error));
    }

    function deleteNotification(notificationId) {
        fetch(`/goat-farm/notifications/${notificationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
                notification.remove();
                updateNotificationCounts();
            }
        })
        .catch(error => console.error('Error deleting notification:', error));
    }

    function markAllAsRead() {
        fetch('/goat-farm/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const markReadButton = item.querySelector('.mark-read');
                    if (markReadButton) {
                        markReadButton.remove();
                    }
                });
                updateNotificationCounts();
            }
        })
        .catch(error => console.error('Error marking all notifications as read:', error));
    }

    function clearAllNotifications() {
        fetch('/goat-farm/notifications/clear-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('.list-group').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No notifications available</p>
                    </div>
                `;
                updateNotificationCounts();
            }
        })
        .catch(error => console.error('Error clearing all notifications:', error));
    }

    function updateNotificationCounts() {
        // Update the unread count in the UI
        const unreadCount = document.querySelectorAll('.notification-item.unread').length;
        document.querySelector('.card-subtitle:contains("Unread")').nextElementSibling.textContent = unreadCount;
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<style>
.notification-item {
    transition: background-color 0.2s;
}

.notification-item.unread {
    background-color: rgba(13, 110, 253, 0.05);
}

.notification-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.notification-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
}

.notification-icon i {
    font-size: 1.2rem;
}

.stat-card .icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
}

.stat-card .icon i {
    font-size: 1.5rem;
}
</style>
{% endblock %} 